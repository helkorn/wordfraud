<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPorn</title>
    <style>
        @font-face {
            font-family: 'C64';
            src: url('fontC64.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Typewriter';
            src: url('fontTW.ttf') format('truetype');
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .container {
            max-width: 800px;
            text-align: center;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 10px;
            background-color: #111;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 20px;
        }
        h1 span {
            color: red;
        }
        .timer {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .shuffled-word {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #fff;
        }
        input[type="text"] {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #222;
            color: #fff;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            autocomplete: off;
            spellcheck: false;
        }
        button {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #333;
            border-radius: 50px;
            background-color: #333;
            color: #fff;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #555;
        }
        .result {
            margin-top: 20px;
            font-size: 1em;
            color: #f00;
        }
        .link-box {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            text-align: right;
        }
        .link-box a {
            color: #888;
            text-decoration: none;
            font-weight: bold;
            padding-right: 20px;
        }
        .link-box a:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none;
        }
        .typewriter-box {
            position: absolute;
            top: 40px;
            right: 20px;
            background-color: #f5f5f5;
            color: #000;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            font-family: 'Typewriter', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            width: 200px;
        }
        .waiting {
            font-size: 0.8em;
            color: #fff;
            animation: waitingAnimation 1.5s infinite;
        }
        @keyframes waitingAnimation {
            0%, 100% {
                color: #888;
            }
            35% {
                color: #444;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body>
    <div class="link-box" id="whatIsThisLink">
        <a href="javascript:void(0)" onclick="showAnalgrammi()">Mikä tämä on?  </a>
    </div>
    <div class="container">
        <h1><span style="color: red;">P</span>WordPorn</h1>
        <p>Analgrammit. Mitä nyt vittua taas.</p>
        <div class="shuffled-word" id="shuffledWord">Ladataan 0%</div>
        <div class="timer" id="timer">20</div>
        <input type="text" id="answer" placeholder="Kirjoita vastaus" autocomplete="off" spellcheck="false">
        <div>
            <button id="solveButton" onclick="checkAnswer()">RATKAISE</button>
        </div>
        <div class="result" id="result"></div>
    </div>

    <script>
        let words = [];
        let wordGroups = [];
        let currentWord = '';
        let timer;
        let timeLeft = 20;
        let paused = false;
        let points = 0;
        let bestScore = 0;
        let currentLevel = 0;

        // Load best score from Firestore
        function loadBestScore() {
            db.doc("/wordporn_scores/O0GVUONRTmF65Q9k9CU2").get().then((doc) => {
                if (doc.exists) {
                    bestScore = doc.data().score;
                } else {
                    bestScore = 0;
                }
            }).catch((error) => {
                console.error("Error getting best score: ", error);
            });
        }

        // Save best score to Firestore
        function saveBestScore(score) {
            db.doc("/wordporn_scores/O0GVUONRTmF65Q9k9CU2").set({
                score: score
            }).then(() => {
                console.log("Best score successfully written!");
            }).catch((error) => {
                console.error("Error writing best score: ", error);
            });
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                if (!paused) {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        handleTimeOut();
                    }
                }
            }, 1000);
        }

        function shuffleWord(word) {
            let shuffledWord = word.split('').sort(() => Math.random() - 0.5).join('');
            while (shuffledWord === word) {
                shuffledWord = word.split('').sort(() => Math.random() - 0.5).join('');
            }
            return shuffledWord;
        }

        function loadNewWord() {
            if (words.length > 0) {
                let wordList = wordGroups[currentLevel];
                currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                const shuffledWord = shuffleWord(currentWord);
                document.getElementById('shuffledWord').textContent = shuffledWord;
                document.getElementById('answer').value = '';
                timeLeft = Math.max(5, 20 - currentLevel);
                document.getElementById('timer').textContent = timeLeft;
                startTimer();
            } else {
                document.getElementById('shuffledWord').textContent = 'Ei sanoja ladattu.';
            }
        }

        function checkAnswer() {
            const answer = document.getElementById('answer').value.trim().toLowerCase();
            if (answer === '') {
                document.getElementById('result').textContent = 'Vastaa nyt jotain menee hermo.';
                return;
            }
            paused = true;
            if (answer === currentWord.toLowerCase()) {
                points += currentWord.length;
                currentLevel = Math.min(wordGroups.length - 1, currentLevel + 1);
                revealCorrectAnswer(() => {
                    document.body.innerHTML = `
                        <div style="color: #fff; text-align: center; font-size: 2em; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            Ok, no nyt pyörii paskaämpäri, pisteet jo ${points} Pidä perse ylhäällä. Ladataan vaikeampi peli..
                        </div>`;
                    setTimeout(() => {
                        loadNewWord();
                        paused = false;
                    }, 3000);
                });
            } else {
                revealCorrectAnswer();
            }
        }

        function revealCorrectAnswer(callback) {
            const shuffledWordElement = document.getElementById('shuffledWord');
            shuffledWordElement.style.color = '#FFFF00';
            let currentIndex = 0;

            const interval = setInterval(() => {
                if (currentIndex < currentWord.length) {
                    shuffledWordElement.textContent =
                        currentWord.slice(0, currentIndex + 1) +
                        shuffledWordElement.textContent.slice(currentIndex + 1);
                    currentIndex++;
                } else {
                    clearInterval(interval);
                    if (callback) {
                        setTimeout(callback, 1500);
                    } else {
                        setTimeout(() => {
                            window.location.href = 'https://timosalonen.github.io/wordfraud/wordporn.html';
                        }, 2000);
                    }
                }
            }, 200);
        }

        function handleTimeOut() {
            revealCorrectAnswer(() => {
                if (points > bestScore) {
                    bestScore = points;
                    saveBestScore(bestScore);
                    showHighScoreInput();
                } else {
                    showGameOver();
                }
            });
        }

        function showGameOver() {
            document.body.innerHTML = `
                <div style="color: #fff; text-align: center; font-size: 2em; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    Pisteesi: ${points}. Petrillä ${bestScore} doinskia. Helvetillinen pettymys, ladataan uusi peli..
                </div>`;
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        function showHighScoreInput() {
            document.body.innerHTML = `
                <div style="color: #fff; text-align: center; font-size: 2em; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    Oho, kauden parhaat ${points}. Kirjoita nimesi alle.
                    <input type="text" id="playerName" placeholder="Nimesi" style="display: block; margin: 20px auto; padding: 10px; font-size: 16px;">
                    <button onclick="savePlayerName()">Tallenna</button>
                </div>`;
        }

        function savePlayerName() {
            const playerName = document.getElementById('playerName').value.trim();
            if (playerName === '') {
                alert('Anna nimi.');
                return;
            }
            db.doc("/wordporn_scores/O0GVUONRTmF65Q9k9CU2").set({
                score: points,
                player: playerName
            }).then(() => {
                alert('Nimi tallennettu!');
                location.reload();
            }).catch((error) => {
                console.error("Error writing player name: ", error);
            });
        }

        function showAnalgrammi() {
            paused = true;
            document.getElementById('timer').innerHTML = '<span class="waiting">-sinulle on postia-</span>';
            const linkBox = document.getElementById('whatIsThisLink');
            linkBox.innerHTML = '';
            const box = document.createElement('div');
            box.id = 'typewriterBox';
            box.className = 'typewriter-box';
            document.body.appendChild(box);
            const text = 'Rakas persehaju,\n\nTämä on helppo peli erityisen vanhoille kuten sinä.\n\nKaikki sanat ovat alatyylisiä kuten sinä.\n\nSanassa on kirjaimet menneet sekaisin kuten sinä.\n\nSiksi se on epäselvä, jos sinäkin.\n\nMuodosta kirjaimista sana. Ole yllättävä kuin äitisi raskaus.\n\nOnnea peliin. Se on helppo kuten sinä.\n\nT Koiranoksennus johon nussit';
            let index = 0;

            function typeNext() {
                if (index < text.length) {
                    box.textContent += text[index];
                    index++;
                    let delay = 40;
                    if (text[index - 1] === ' ' || text[index - 1] === '\n') {
                        delay = 100;
                    }
                    setTimeout(typeNext, delay);
                } else {
                    setTimeout(removeText, 3000); // Lisätty ylimääräinen sekunti
                }
            }

            function removeText() {
                document.getElementById('timer').innerHTML = timeLeft; // Nopeutettu muutos kelloksi
                let grayValue = 245;
                let upperIndex = 0;
                const lines = box.textContent.split('\n');
                const interval = setInterval(() => {
                    if (box.textContent.length > 0) {
                        if (upperIndex < lines.length) {
                            lines[upperIndex] = '';
                            upperIndex++;
                            box.textContent = lines.join('\n');
                        } else {
                            const randomIndex = Math.floor(Math.random() * box.textContent.length);
                            box.textContent = box.textContent.slice(0, randomIndex) + box.textContent.slice(randomIndex + 1);
                        }
                        grayValue -= 5;
                        box.style.backgroundColor = `rgb(${grayValue}, ${grayValue}, ${grayValue})`;
                    } else {
                        clearInterval(interval);
                        box.remove();
                        paused = false;
                        startTimer();
                    }
                }, 30);
            }

            typeNext();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch('wordpornFI.csv')
                .then(response => response.text())
                .then(text => {
                    words = text.split('\n').map(word => word.trim()).filter(Boolean);
                    words.sort((a, b) => a.length - b.length);
                    let step = Math.ceil(words.length / 20);
                    for (let i = 0; i < 20; i++) {
                        wordGroups.push(words.slice(i * step, (i + 1) * step));
                    }
                    loadNewWord();
                });
            loadBestScore();
        });

        document.getElementById('answer').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
    </script>
</body>
</html>
