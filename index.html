<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timin WordFraud</title>
    <style>
        /* ... tyyliä, joka pysyy samana ... */
    </style>
</head>
<body>
    <div class="link-box" id="whatIsThisLink">
        <a href="javascript:void(0)" onclick="showOptions()">What is this? </a>
    </div>
    <div class="container" id="mainContent">
        <div class="input-container" id="inputContainer">
            <h1>WordFraud 1.0</h1>
            <input type="text" id="letters" placeholder="Syötä kirjaimet (esim. aertspl)" autocomplete="off" disabled>
            <button id="fraudeloiButton" onclick="findWords()" disabled>Fraudeloi</button>
        </div>
        <div class="container" id="mainContainer" style="display: none;">
            <div class="result-title" id="resultTitle"></div>
            <div class="centered">
                <div class="highlight" id="highlightMessage" style="display: none;">Huippuhyvä löytö!</div>
                <div class="super-highlight" id="superHighlightMessage" style="display: none;">SUPERLÖYTÖ!</div>
            </div>
            <div class="columns">
                <div class="column" id="column"></div>
            </div>
            <div class="centered">
                <button class="reset-button" id="resetButton" onclick="resetPage()">Uudelleen</button>
            </div>
        </div>
    </div>
    
    <div class="full-screen-image" id="rabbitImage" style="display: none;">
        <img src="therabbit.png" alt="Jänis">
    </div>

    <div class="link-box hidden" id="optionsContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0"></script>
    <script>
        let words = new Set();
        let offensiveWords = new Set();
        let isDataLoaded = false;
        let isOffensiveLoaded = false;
        const medianThreshold = 50;
        const superThreshold = 75;
        const translateApiKey = 'AIzaSyDdmqFZttVpbpzvRU3sIu1-Ws4jI4iIEGo';
        const unsplashAccessKey = 'gBPFkxZCEH2EV6t8GaezB2_WM2QVkVUnkCHP0bITUos';

        Papa.parse('https://raw.githubusercontent.com/timosalonen/wordfraud/main/wordfraudFI.csv', {
            download: true,
            complete: function(results) {
                results.data.flat().map(word => word.trim()).filter(Boolean).forEach(word => {
                    words.add(word.toLowerCase());
                });
                console.log('Sanat ladattu:', words.size);
                isDataLoaded = true;
                checkIfAllLoaded();
            }
        });

        Papa.parse('https://raw.githubusercontent.com/timosalonen/wordfraud/main/offensiveFI.csv', {
            download: true,
            complete: function(results) {
                results.data.flat().map(word => word.trim()).filter(Boolean).forEach(word => {
                    offensiveWords.add(word.toLowerCase());
                });
                console.log('Rivot sanat ladattu:', offensiveWords.size);
                isOffensiveLoaded = true;
                checkIfAllLoaded();
            }
        });

        function checkIfAllLoaded() {
            if (isDataLoaded && isOffensiveLoaded) {
                document.getElementById('letters').disabled = false;
                document.getElementById('fraudeloiButton').disabled = false;
            }
        }

        function isValidWord(word) {
            return words.has(word);
        }

        function isOffensiveWord(word) {
            return offensiveWords.has(word);
        }

        function getAllCombinations(letters) {
            let results = new Set();

            function combine(prefix, letters) {
                for (let i = 0; i < letters.length; i++) {
                    let newPrefix = prefix + letters[i];
                    if (isValidWord(newPrefix)) {
                        results.add(newPrefix);
                    }
                    combine(newPrefix, letters.slice(0, i) + letters.slice(i + 1));
                }
            }

            combine('', letters);
            
            // Muunnetaan setti taulukoksi ja lajitellaan ensin pituuden mukaan (pisin ensin) ja sitten aakkosjärjestykseen
            return Array.from(results).sort((a, b) => b.length - a.length || a.localeCompare(b));
        }

        function findWords() {
            if (!isDataLoaded || !isOffensiveLoaded) {
                alert('Sanat eivät ole vielä latautuneet. Odota hetki ja yritä uudelleen.');
                return;
            }

            const letters = document.getElementById('letters').value.toUpperCase();
            const column = document.getElementById('column');
            const resultTitle = document.getElementById('resultTitle');
            const highlightMessage = document.getElementById('highlightMessage');
            const superHighlightMessage = document.getElementById('superHighlightMessage');
            const fraudeloiButton = document.getElementById('fraudeloiButton');
            const resetButton = document.getElementById('resetButton');
            const mainContainer = document.getElementById('mainContainer');
            const inputContainer = document.getElementById('inputContainer');
            const rabbitImage = document.getElementById('rabbitImage');
            column.innerHTML = '';
            resultTitle.style.display = 'none';
            highlightMessage.style.display = 'none';
            superHighlightMessage.style.display = 'none';
            if (letters.length < 2 || letters.length > 9) {
                alert("Anna 2-9 kirjainta. Annoit " + letters.length + ".");
                return;
            }
            console.time('findPossibleWords');
            const possibleWords = getAllCombinations(letters.toLowerCase());
            console.timeEnd('findPossibleWords');

            const containsOffensive = possibleWords.some(word => isOffensiveWord(word.toLowerCase()));

            if (possibleWords.length === 0) {
                const noResults = document.createElement('div');
                noResults.textContent = 'Ei löydettyjä sanoja';
                noResults.classList.add('no-results');
                column.appendChild(noResults);
            } else {
                possibleWords.forEach((word) => {
                    const li = document.createElement('li');
                    li.textContent = word.toUpperCase();
                    li.onclick = () => findWordsForWord(word.toUpperCase());
                    li.id = `word-${word.toUpperCase()}`;
                    column.appendChild(li);
                });
            }

            const resultCount = possibleWords.length - 1;

            if (resultCount > superThreshold) {
                superHighlightMessage.style.display = 'block';
                showConfetti();
                resultTitle.textContent = `Kysyit: ${letters}. ${letters.length} kirjainta ja ${resultCount} sanaa`;
            } else if (resultCount > medianThreshold) {
                highlightMessage.style.display = 'block';
                resultTitle.textContent = `Kysyit: ${letters}. ${letters.length} kirjainta ja ${resultCount} sanaa`;
            } else {
                resultTitle.textContent = `Kysyit: ${letters}`;
            }

            inputContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            resultTitle.style.display = 'block';
            resetButton.style.display = 'block';

            if (letters === 'JÄNIS') {
                resultTitle.textContent += ". Onks kello hyvin?";
                setTimeout(() => {
                    rabbitImage.style.display = 'flex';
                    setTimeout(() => {
                        rabbitImage.style.display = 'none';
                        resultTitle.innerHTML = `Kysyit: ${letters}. <a href="https://youtu.be/0wHXcv4Q4Sk" style="color: black; text-decoration: underline;">Hei mikä toi on?</a>`;
                    }, 1500);
                }, 500);
            }

            window.scrollTo(0, 0);

            translateAndShowImage(letters);
        }

        function translateAndShowImage(word) {
            const url = `https://translation.googleapis.com/language/translate/v2?key=${translateApiKey}`;
            const data = {
                q: word,
                source: 'fi',
                target: 'en',
                format: 'text'
            };

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const translatedWord = data.data.translations[0].translatedText;
                fetchImage(word, translatedWord);
            })
            .catch(error => {
                console.error('Error translating the word:', error);
            });
        }

        function fetchImage(word, translatedWord) {
            fetch(`https://api.unsplash.com/photos/random?query=${translatedWord}&client_id=${unsplashAccessKey}`)
                .then(response => response.json())
                .then(data => {
                    const imageUrl = data.urls.small;
                    const wordElement = document.getElementById(`word-${word.toUpperCase()}`);
                    if (wordElement) {
                        wordElement.style.backgroundImage = `url(${imageUrl})`;
                        wordElement.classList.add('has-background-image');
                        wordElement.innerHTML = `<span>${word.toUpperCase()}</span>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching the image:', error);
                });
        }

        function showOptions() {
            document.getElementById('whatIsThisLink').style.display = 'none';
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.classList.remove('hidden');
            optionsContainer.style.position = 'fixed';
            optionsContainer.style.top = '20px';
            optionsContainer.style.right = '20px';
            optionsContainer.innerHTML = `
                <p>Did you mean..?</p>
                <div class="option-container">
                    <a class="option-text" onclick="chooseOption('this')">What is this</a> or<br>
                    <a class="option-text" onclick="chooseOption('that')">What is that?</a>
                </div>
            `;
        }

        function chooseOption(option) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (option === 'this') {
                optionsContainer.innerHTML = `
                    <p>This is where you are.</p>
                    <div class="option-container">
                        <a class="option-text" href="https://youtu.be/N2ICtCO8TCw">Take That</a><br>
                        <a class="option-text" onclick="continueOption()">or Continue</a>
                    </div>
                `;
            } else if (option === 'that') {
                optionsContainer.innerHTML = `
                    <p>That is like an imperfect of this.</p>
                    <div class="option-container">
                        <a class="option-text" onclick="lockInAnswer()">Sure thing, I call</a><br>
                        <a class="option-text" href="https://youtu.be/-crgQGdpZR0">Take a Chance</a>
                    </div>
                `;
            }
        }

        function continueOption() {
            document.body.innerHTML = '<canvas></canvas>';
            var canvas = document.querySelector('canvas');
            var ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.font = '20px C64';
            ctx.fillStyle = '#696969';

            document.fonts.load('20px C64').then(() => {
                var lines = [
                    '',
                    '',
                    '*** WORDFRAUD V 1.0 ***',
                    'READY.',
                    '',
                    'SYS 64738 : REM KILL SWITCH',
                    'POKE 53280, 0',
                    'READY.',
                    '',
                    '10 INPUT "CHOOSE YOUR PILL 1 or 2:", V',
                    '20 IF V = 1 THEN GOTO 10',
                    '30 IF V = 2 THEN GOTO 3000',
                    '40 IF V <> 1 AND V <> 2 THEN GOSUB 3500',
                    '50 END',
                    '',
                    '3010 LOAD "PACMAN",8,1',
                    '3020 RUN',
                    '',
                    '3500 PRINT "You take the blue pill, the story ends."',
                    '3510 PRINT "You wake up in your bed and believe whatever you want to believe."',
                    '3520 PRINT "You take the red pill, you stay in Wonderland,"',
                    '3530 PRINT "and I show you how deep the rabbit hole goes."',
                    '3540 END'
                ];

                var y = 20;
                var delay = 100;

                lines.forEach((line, index) => {
                    setTimeout(() => {
                        ctx.fillText(line, 20, y);
                        y += 20;
                    }, delay * index);
                });

                setTimeout(() => {
                    ctx.fillText('READY.', 20, y);
                    y += 20;
                    ctx.fillRect(20, y, 10, 20);
                }, delay * lines.length);

                setTimeout(() => {
                    window.location.href = 'pacman.html';
                }, delay * lines.length + 4500);
            });
        }

        function lockInAnswer() {
            window.location.href = 'wordporn.html';
        }

        function findWordsForWord(word) {
            document.getElementById('letters').value = word;
            findWords();
        }

        function resetPage() {
            location.reload();
        }
    </script>
</body>
</html>
